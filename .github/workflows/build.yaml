on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout infra repo
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          echo "APP_PUBLIC_HOST=${{ vars.APP_PUBLIC_HOST }}" >> $GITHUB_ENV
          echo "API_PUBLIC_HOST=${{ vars.API_PUBLIC_HOST }}" >> $GITHUB_ENV
          echo "PLEX_PRIVATE_HOST=${{ vars.PLEX_PRIVATE_HOST }}" >> $GITHUB_ENV
          echo "ARGO_FAMILY_HOST=${{ vars.ARGO_FAMILY_HOST }}" >> $GITHUB_ENV
          echo "ARGO_PUBLIC_HOST=${{ vars.ARGO_PUBLIC_HOST }}" >> $GITHUB_ENV
          echo "ELK_FAMILY_HOST=${{ vars.ELK_FAMILY_HOST }}" >> $GITHUB_ENV
          echo "ELK_PUBLIC_HOST=${{ vars.ELK_PUBLIC_HOST }}" >> $GITHUB_ENV
          echo "FAMILY_API_HOST=${{ vars.FAMILY_API_HOST }}" >> $GITHUB_ENV
          echo "FAMILY_PUBLIC_HOST=${{ vars.FAMILY_PUBLIC_HOST }}" >> $GITHUB_ENV
          echo "PLEX_PRIVATE_HOST=${{ vars.PLEX_PRIVATE_HOST }}" >> $GITHUB_ENV
          echo "PROM_FAMILY_HOST=${{ vars.PROM_FAMILY_HOST }}" >> $GITHUB_ENV
          echo "PROM_PUBLIC_HOST=${{ vars.PROM_PUBLIC_HOST }}" >> $GITHUB_ENV

      - name: Render cvshowcase-frontend manifests
        run: |
          mkdir -p rendered
          helm template cvshowcase-frontend apps/charts/cvshowcase-frontend \
            --set ingress.host=${APP_PUBLIC_HOST} \
            > rendered/cvshowcase-frontend.yaml

      - name: Render cvshowcase-backend manifests
        run: |
          helm template cvshowcase-backend apps/charts/cvshowcase-backend \
            --set ingress.host=${API_PUBLIC_HOST} \
            > rendered/cvshowcase-backend.yaml

      - name: Render plex manifests
        run: |
          helm template plex apps/charts/plex \
            --set ingress.host=${PLEX_PRIVATE_HOST} \
            > rendered/plex.yaml

      - name: Render plex manifests
        run: |
          helm template cvshowcase-backend apps/charts/cvshowcase-backend \
            --set ingress.host=${API_PUBLIC_HOST} \
            > rendered/cvshowcase-backend.yaml
          helm template cvshowcase-frontend apps/charts/cvshowcase-frontend \
            --set ingress.host=${APP_PUBLIC_HOST} \
            > rendered/cvshowcase-frontend.yaml
          helm template plex apps/charts/plex \
            --set ingress.host=${PLEX_PRIVATE_HOST} \
            > rendered/plex.yaml

      - name: Checkout private env repo
        uses: actions/checkout@v4
        with:
          repository: bitoatt/private-homelab-env
          token: ${{ secrets.ENV_REPO_PAT }}
          path: env-repo

      - name: Copy manifests into env repo
        run: |
          mkdir -p env-repo/clusters/vulcan/apps
          cp rendered/cvshowcase-frontend.yaml env-repo/clusters/vulcan/apps/
          cp rendered/cvshowcase-backend.yaml env-repo/clusters/vulcan/apps/
          cp rendered/plex.yaml env-repo/clusters/vulcan/apps/

      - name: Commit & push
        run: |
          cd env-repo
          git config user.name "cvshowcase-bot"
          git config user.email "bot@attilabito.com"

          git add clusters/vulcan/apps/cvshowcase-frontend.yaml \
                  clusters/vulcan/apps/cvshowcase-backend.yaml \
                  clusters/vulcan/apps/plex.yaml

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update rendered manifests from infra"
            git push
          fi

